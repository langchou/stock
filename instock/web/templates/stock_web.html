{% extends "layout/default.html" %}

{% block main_content %}
<link rel="stylesheet" href="/static/css/bootstrap-datepicker3.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.3.3/styles/ag-grid.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.3.3/styles/ag-theme-balham.min.css" />
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@32.3.3/dist/ag-grid-community.min.noStyle.js"></script>
<script src="/static/js/bootstrap-datepicker.min.js"></script>
<script src="/static/js/bootstrap-datepicker.zh-CN.min.js"></script>
<style>
.ag-theme-balham .ag-header-cell-label .ag-header-cell-text {
    white-space: normal !important;
    line-height: 1.2;
}
.ag-theme-balham .ag-header-cell {
    padding: 4px 6px;
}
.cell-red { color: red; }
.cell-green { color: green; }
.code-link { color: #1a73e8; cursor: pointer; text-decoration: underline; }
.code-link:hover { color: #0d47a1; }
#statusBar {
    background: #f5f5f5;
    border-top: 1px solid #ddd;
    padding: 2px 10px;
    font-size: 12px;
    line-height: 20px;
}
</style>

<div style="height: 100%;overflow: hidden;">
    <div class="table-header" style="width:100%;height:35px;">
        <div style="display:inline-block;float:left;height:100%;">
            <div style="display:inline-block;float:left;text-overflow:ellipsis;white-space:nowrap;">
                {{ web_module_data.name }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;日期：
            </div>
            <div style="display:inline-block;float:right;">
                <input type="hidden" id="dateid_old">
                <input type="text" value="{{ date_now }}" id="dateid" class="input-group-sm form-control date-picker">
            </div>
        </div>
        <div style="display:inline-block;float:right;height:100%;">
            <input type="button" id="resetFilter" value="重置筛选" style="background-color:#307ECC;height:100%;color:#fff;border:none;padding:0 12px;cursor:pointer;">
            <input type="button" id="saveExcel" value="保存CSV" style="background-color:#307ECC;height:100%;color:#fff;border:none;padding:0 12px;cursor:pointer;">
        </div>
    </div>
    <div id="instock-data" class="ag-theme-balham" style="width:100%;height:calc( 100% - 55px );"></div>
    <div id="statusBar"><i class="fa fa-commenting-o"></i> 总记录/筛选记录：<b id="totalCount">0</b> / <b id="filteredCount">0</b> 条 - 当前位置：第 <b id="currentRow">0</b> 行</div>
</div>

<script type="text/javascript">
    const nameParam = $.getUrlVar('table_name');
    let dateParam = "{{ date_now }}";
    const colInfos = {% raw web_module_data.column_names %};
    let gridApi = null;

    function buildColumnDefs(colInfos) {
        return colInfos.map(function(col, index) {
            let def = {
                field: col.value,
                headerName: col.caption,
                width: col.width + 20,
                sortable: true,
                filter: true,
                resizable: true,
                headerTooltip: col.caption,
                wrapHeaderText: true,
                autoHeaderHeight: true
            };
            // 前3列固定
            if (index < 3) {
                def.pinned = 'left';
            }
            // code 列加超链接
            if (col.value === 'code') {
                def.cellRenderer = function(params) {
                    if (!params.value) return '';
                    let a = document.createElement('a');
                    a.className = 'code-link';
                    a.textContent = params.value;
                    a.onclick = function() {
                        let rowData = params.data;
                        window.open('/instock/data/indicators?code=' + rowData.code + '&date=' + rowData.date + '&name=' + (rowData.name || ''), '_blank');
                    };
                    return a;
                };
            }
            // 涨跌幅红涨绿跌
            if (col.value === 'change_rate') {
                def.cellStyle = function(params) {
                    if (params.value > 0) return { color: 'red' };
                    if (params.value < 0) return { color: 'green' };
                    return null;
                };
            }
            return def;
        });
    }

    function updateStatusBar() {
        if (!gridApi) return;
        let total = 0;
        let filtered = 0;
        gridApi.forEachNode(function() { total++; });
        gridApi.forEachNodeAfterFilter(function() { filtered++; });
        document.getElementById('totalCount').textContent = total;
        document.getElementById('filteredCount').textContent = filtered;
    }

    function loadData() {
        const dateVal = document.getElementById('dateid').value;
        const oldVal = document.getElementById('dateid_old').value;
        if (dateVal === oldVal) return;
        document.getElementById('dateid_old').value = dateVal;
        dateParam = dateVal;

        fetch('/instock/api_data?name=' + nameParam + '&date=' + dateParam)
            .then(function(resp) {
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                var ct = resp.headers.get('content-type') || '';
                if (ct.indexOf('json') === -1) throw new Error('非JSON响应');
                return resp.json();
            })
            .then(function(data) {
                if (gridApi) {
                    gridApi.setGridOption('rowData', data);
                    updateStatusBar();
                }
            })
            .catch(function(err) { console.error('数据加载失败:', err); });
    }

    $(document).ready(function () {
        const columnDefs = buildColumnDefs(colInfos);
        const gridOptions = {
            columnDefs: columnDefs,
            rowData: [],
            defaultColDef: {
                sortable: true,
                filter: true,
                resizable: true,
                minWidth: 50
            },
            rowSelection: 'single',
            animateRows: true,
            enableCellTextSelection: true,
            onFilterChanged: updateStatusBar,
            onSelectionChanged: function(event) {
                let rows = event.api.getSelectedNodes();
                if (rows.length > 0) {
                    document.getElementById('currentRow').textContent = rows[0].rowIndex + 1;
                }
            },
            onGridReady: function(params) {
                gridApi = params.api;
                loadData();
            }
        };

        const gridDiv = document.getElementById('instock-data');
        agGrid.createGrid(gridDiv, gridOptions);

        // 日期选择器
        $(".date-picker").datepicker({
            language: 'zh-CN',
            format: "yyyy-mm-dd",
            showOtherMonths: true,
            selectOtherMonths: false,
            autoclose: true,
            todayHighlight: true
        }).on('changeDate', function() {
            loadData();
        });

        // 重置筛选
        document.getElementById('resetFilter').onclick = function() {
            if (gridApi) {
                gridApi.setFilterModel(null);
                updateStatusBar();
            }
        };

        // 导出 CSV
        document.getElementById('saveExcel').onclick = function() {
            if (gridApi) {
                gridApi.exportDataAsCsv({
                    fileName: nameParam + dateParam + '.csv'
                });
            }
        };
    });
</script>
{% end %}
